syntax = "proto3";

package orbit.v1;

service StarService {
  // --- 1. Connection & Auth ---
  // Establishes identity and capabilities.
  rpc Handshake (HandshakeRequest) returns (HandshakeResponse);

  // --- 2. Discovery ---
  // Lists files in a directory. Returns a stream to handle massive folders (1M+ files).
  rpc ScanDirectory (ScanRequest) returns (stream FileEntry);

  // --- 3. Intelligence ---
  // Reads the first N bytes for semantic analysis (magic numbers).
  rpc ReadHeader (ReadHeaderRequest) returns (ReadHeaderResponse);

  // --- 4. Compute (CDC) ---
  // The Heavy Lifter: Hashes a file range on the remote CPU.
  rpc CalculateHash (HashRequest) returns (HashResponse);
}

// --- Message Types ---

message HandshakeRequest {
  string star_token = 1;       // The "Join Token" generated by Nucleus
  string version = 2;          // Agent version (e.g., "0.6.0")
  repeated string capabilities = 3; // ["zstd", "avx2", "gpu"]
}

message HandshakeResponse {
  bool accepted = 1;
  string session_id = 2;
  string nucleus_version = 3;
}

message ScanRequest {
  string path = 1;
}

message FileEntry {
  string name = 1;
  uint64 size = 2;
  bool is_dir = 3;
  uint64 modified_at_ts = 4; // Unix Timestamp
  // Note: Full path is inferred from request + name
}

message ReadHeaderRequest {
  string path = 1;
  uint32 length = 2;
}

message ReadHeaderResponse {
  bytes data = 1;
}

message HashRequest {
  string path = 1;
  uint64 offset = 2;
  uint64 length = 3;
}

message HashResponse {
  bytes hash = 1; // 32 bytes (BLAKE3)
}
