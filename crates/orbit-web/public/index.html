<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit Nebula - Control Center</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --border: #374151;
            --text: #f9fafb;
            --text-dim: #9ca3af;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Hide views properly */
        .hidden { display: none !important; }

        /* Login Page */
        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at top, #1a1f35 0%, var(--bg-dark) 50%);
        }

        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .login-logo p {
            color: var(--text-dim);
            font-size: 0.95rem;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-hint {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button .btn {
            white-space: nowrap;
        }

        .node-config-desc {
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .browse-mode-banner {
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
        }

        .browse-mode-banner .btn {
            background: white;
            color: var(--accent);
        }

        .browse-mode-banner .btn-secondary {
            background: transparent;
            border: 1px solid white;
            color: white;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white;
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
        }

        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }

        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .hint-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .hint-box code {
            color: var(--accent-light);
            font-weight: 600;
        }

        /* Dashboard Page */
        #dashboard-page {
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
        }

        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: var(--accent); color: white; }

        .nav-icon { font-size: 1.25rem; }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .user-details h4 { font-size: 0.9rem; font-weight: 600; }
        .user-details span { font-size: 0.75rem; color: var(--text-dim); }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-dark);
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .page-header p { color: var(--text-dim); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.green::before { background: var(--success); }
        .stat-card.blue::before { background: var(--info); }
        .stat-card.yellow::before { background: var(--warning); }
        .stat-card.purple::before { background: var(--accent); }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-body { padding: 1.5rem; }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
        }

        .table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            border-bottom: 1px solid var(--border);
        }

        .table tr:last-child td { border-bottom: none; }
        .table tr:hover td { background: var(--bg-hover); }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--info); }

        /* Progress */
        .progress {
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
            width: 120px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #a855f7);
            transition: width 0.3s;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        /* API Explorer */
        .api-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .api-method select, .api-url input {
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .api-method select { width: 120px; }
        .api-url { flex: 1; }
        .api-url input { width: 100%; font-family: monospace; }

        .api-body textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .api-response {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .response-ok { color: var(--success); }
        .response-err { color: var(--danger); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-weight: 600; font-size: 1.1rem; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text); }

        .modal-body { padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Action buttons */
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-info { background: var(--info); color: white; }
        .btn-info:hover { opacity: 0.9; }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
        }

        /* Checkbox toggle */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .toggle.active { background: var(--accent); border-color: var(--accent); }
        .toggle.active::after { left: 22px; background: white; }

        /* Job detail */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .detail-item {
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1rem;
            word-break: break-all;
        }

        .detail-item.full { grid-column: 1 / -1; }

        .quick-btns {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* WebSocket */
        .ws-log {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .ws-event {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .ws-event:last-child { border-bottom: none; }
        .ws-time { color: var(--text-dim); margin-right: 0.5rem; }

        /* Section tabs */
        .section { display: none; }
        .section.active { display: block; }

        /* Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* File Explorer */
        .file-browser {
            background: var(--bg-dark);
            border-radius: 8px;
            min-height: 400px;
        }

        .file-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            flex-wrap: wrap;
        }

        .file-path {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.85rem;
            min-width: 200px;
        }

        .file-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .file-item:hover { background: var(--bg-hover); }
        .file-item:last-child { border-bottom: none; }

        .file-icon { font-size: 1.25rem; width: 28px; text-align: center; }
        .file-name { flex: 1; font-size: 0.9rem; }
        .file-size { color: var(--text-dim); font-size: 0.8rem; min-width: 80px; text-align: right; }
        .file-date { color: var(--text-dim); font-size: 0.8rem; min-width: 140px; text-align: right; }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .drop-zone-icon { font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.5; }
        .drop-zone-text { color: var(--text-dim); margin-bottom: 0.5rem; }
        .drop-zone input[type="file"] { display: none; }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .upload-progress.active { display: block; }

        .upload-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .upload-name { flex: 1; font-size: 0.85rem; }
        .upload-status { font-size: 0.75rem; color: var(--text-dim); }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: var(--accent-light);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-sep { color: var(--text-dim); font-size: 0.85rem; }

        /* Drive selector */
        .drive-select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
        }

        /* Pipeline Builder */
        .pipeline-canvas-container {
            position: relative;
            background: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
            transition: all 0.2s ease;
        }

        .pipeline-canvas-container.drag-over {
            background: rgba(99, 102, 241, 0.1);
            outline: 2px dashed var(--accent);
            outline-offset: -2px;
        }

        #nodes-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #nodes-layer .dag-node {
            pointer-events: auto;
        }

        .pipeline-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .pipeline-canvas path {
            pointer-events: auto;
            cursor: pointer;
        }

        .pipeline-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .pipeline-toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid var(--border);
            margin-right: 0.5rem;
        }

        .pipeline-toolbar-group:last-child {
            border-right: none;
            margin-right: 0;
        }

        .node-palette {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .pipeline-help {
            padding: 0.5rem 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .pipeline-help .help-highlight {
            color: var(--accent);
            font-weight: 600;
        }

        .pipeline-validation {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        .pipeline-validation.valid {
            background: rgba(16, 185, 129, 0.15);
            border-bottom: 1px solid var(--success);
            color: var(--success);
        }

        .pipeline-validation.invalid {
            background: rgba(239, 68, 68, 0.15);
            border-bottom: 1px solid var(--danger);
            color: var(--danger);
        }

        .pipeline-validation ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .node-palette-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: grab;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: grab;
            font-size: 0.8rem;
            transition: all 0.15s;
        }

        .node-palette-item:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .node-palette-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .node-icon { font-size: 1rem; }

        /* DAG Node Styles */
        .dag-node {
            position: absolute;
            min-width: 140px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: move;
            user-select: none;
            z-index: 10;
            transition: box-shadow 0.15s;
        }

        .dag-node:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dag-node.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        .dag-node-header {
            padding: 0.5rem 0.75rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .dag-node-body {
            padding: 0.75rem;
        }

        .dag-node-name {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .dag-node-type {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .dag-node-port {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--border);
            border: 2px solid var(--bg-dark);
            border-radius: 50%;
            cursor: crosshair;
            z-index: 20;
        }

        .dag-node-port:hover {
            background: var(--accent);
            transform: scale(1.3);
        }

        .dag-node-port.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .dag-node-port.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .dag-node-port.input:hover,
        .dag-node-port.output:hover {
            transform: translateY(-50%) scale(1.3);
        }

        /* Node type colors */
        .dag-node.source .dag-node-header { background: rgba(16, 185, 129, 0.2); }
        .dag-node.destination .dag-node-header { background: rgba(239, 68, 68, 0.2); }
        .dag-node.transfer .dag-node-header { background: rgba(59, 130, 246, 0.2); }
        .dag-node.transform .dag-node-header { background: rgba(168, 85, 247, 0.2); }
        .dag-node.filter .dag-node-header { background: rgba(245, 158, 11, 0.2); }
        .dag-node.merge .dag-node-header { background: rgba(99, 102, 241, 0.2); }
        .dag-node.split .dag-node-header { background: rgba(236, 72, 153, 0.2); }
        .dag-node.conditional .dag-node-header { background: rgba(14, 165, 233, 0.2); }

        /* Pipeline list */
        .pipeline-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .pipeline-list-item:hover { background: var(--bg-hover); }
        .pipeline-list-item:last-child { border-bottom: none; }

        .pipeline-info { flex: 1; }
        .pipeline-name { font-weight: 600; margin-bottom: 0.25rem; }
        .pipeline-meta { font-size: 0.8rem; color: var(--text-dim); }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .sidebar { width: 220px; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="login-page">
        <div class="login-container">
            <div class="login-logo">
                <h1>Orbit Nebula</h1>
                <p>Data Orchestration Control Center</p>
            </div>
            <div class="login-box">
                <div class="error-msg hidden" id="login-error"></div>
                <form id="login-form" onsubmit="login(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
                </form>
                <div class="hint-box">
                    Default: <code>admin</code> / <code>orbit2025</code>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboard-page" class="hidden">
        <aside class="sidebar">
            <div class="sidebar-logo">Orbit Nebula</div>
            <nav>
                <div class="nav-item active" onclick="showSection('overview')">
                    <span class="nav-icon">üìä</span> Overview
                </div>
                <div class="nav-item" onclick="showSection('jobs')">
                    <span class="nav-icon">üìã</span> Jobs
                </div>
                <div class="nav-item" onclick="showSection('backends')">
                    <span class="nav-icon">üóÑÔ∏è</span> Backends
                </div>
                <div class="nav-item" onclick="showSection('files')">
                    <span class="nav-icon">üìÅ</span> Files
                </div>
                <div class="nav-item" onclick="showSection('pipelines')">
                    <span class="nav-icon">üîÄ</span> Pipelines
                </div>
                <div class="nav-item" id="nav-users" style="display:none;" onclick="showSection('users')">
                    <span class="nav-icon">üë•</span> Users
                </div>
                <div class="nav-item" onclick="showSection('api')">
                    <span class="nav-icon">üîå</span> API Explorer
                </div>
                <div class="nav-item" onclick="showSection('websocket')">
                    <span class="nav-icon">‚ö°</span> WebSocket
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-details">
                        <h4 id="user-name">Admin</h4>
                        <span id="user-role">Administrator</span>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="logout()">Sign Out</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- OVERVIEW SECTION -->
            <div id="section-overview" class="section active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <p>Real-time system monitoring and control</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üü¢</div>
                        <div class="stat-value" id="stat-status">Online</div>
                        <div class="stat-label">Server Status</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">üìÇ</div>
                        <div class="stat-value" id="stat-active">0</div>
                        <div class="stat-label">Active Transfers</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="stat-completed">0</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-icon">üì°</div>
                        <div class="stat-value" id="stat-ws">--</div>
                        <div class="stat-label">WebSocket</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Recent Activity</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadJobs()">Refresh</button>
                    </div>
                    <div class="card-body" id="recent-jobs">
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No recent activity</h3>
                            <p>Transfer jobs will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JOBS SECTION -->
            <div id="section-jobs" class="section">
                <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <h1>Transfer Jobs</h1>
                        <p>Manage and monitor file transfers</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showCreateJobModal()">+ New Job</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Jobs</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadJobs()">Refresh</button>
                    </div>
                    <div class="card-body" id="all-jobs">
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No jobs found</h3>
                            <p>Click "New Job" to create a transfer job</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BACKENDS SECTION -->
            <div id="section-backends" class="section">
                <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <h1>Storage Backends</h1>
                        <p>Configure S3, SMB, and local storage connections</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showCreateBackendModal()">+ Add Backend</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Configured Backends</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadBackends()">Refresh</button>
                    </div>
                    <div class="card-body" id="backends-list">
                        <div class="empty-state">
                            <div class="empty-icon">üóÑÔ∏è</div>
                            <h3>No backends configured</h3>
                            <p>Click "Add Backend" to configure storage</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILES SECTION -->
            <div id="section-files" class="section">
                <div class="page-header">
                    <h1>File Explorer</h1>
                    <p>Browse directories and upload files</p>
                </div>

                <!-- Drop Zone for Upload -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Upload Files</span>
                    </div>
                    <div class="card-body">
                        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                            <div class="drop-zone-icon">üì§</div>
                            <div class="drop-zone-text">Drag & drop files here or click to browse</div>
                            <div style="font-size:0.75rem;color:var(--text-dim);">Files will be uploaded to the current directory</div>
                            <input type="file" id="file-input" multiple onchange="handleFileSelect(event)">
                        </div>
                        <div id="upload-progress" class="upload-progress"></div>
                    </div>
                </div>

                <!-- File Browser -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Directory Browser</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadDirectory()">Refresh</button>
                    </div>
                    <div class="card-body" style="padding:0;">
                        <div class="file-browser">
                            <div class="file-toolbar">
                                <select id="drive-select" class="drive-select" onchange="changeDrive()"></select>
                                <input type="text" id="current-path" class="file-path" value="C:\\" onkeydown="if(event.key==='Enter')navigateToPath()">
                                <button class="btn btn-secondary btn-sm" onclick="navigateUp()">‚¨ÜÔ∏è Up</button>
                                <button class="btn btn-primary btn-sm" onclick="selectPath()">Select Path</button>
                            </div>
                            <div class="file-list" id="file-list">
                                <div class="empty-state">
                                    <div class="empty-icon">üìÇ</div>
                                    <h3>Loading...</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USERS SECTION (Admin Only) -->
            <div id="section-users" class="section">
                <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <h1>User Management</h1>
                        <p>Manage user accounts and roles (Admin only)</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showCreateUserModal()">+ Add User</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Users</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadUsers()">Refresh</button>
                    </div>
                    <div class="card-body" id="users-list">
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <h3>Loading users...</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PIPELINES SECTION -->
            <div id="section-pipelines" class="section">
                <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <h1>Visual Pipeline Builder</h1>
                        <p>Create and manage DAG-based transfer workflows</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showCreatePipelineModal()">+ New Pipeline</button>
                </div>

                <!-- Pipeline List -->
                <div class="card" id="pipeline-list-card">
                    <div class="card-header">
                        <span class="card-title">Saved Pipelines</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadPipelines()">Refresh</button>
                    </div>
                    <div class="card-body" id="pipelines-list" style="padding:0;">
                        <div class="empty-state">
                            <div class="empty-icon">üîÄ</div>
                            <h3>No pipelines yet</h3>
                            <p>Click "New Pipeline" to create your first workflow</p>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Editor (hidden by default) -->
                <div class="card hidden" id="pipeline-editor-card">
                    <div class="card-header">
                        <span class="card-title" id="pipeline-editor-title">Pipeline Editor</span>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="closePipelineEditor()">Back to List</button>
                            <button class="btn btn-primary btn-sm" onclick="validatePipeline()">Validate</button>
                            <button class="btn btn-success btn-sm" onclick="savePipeline()">Save</button>
                        </div>
                    </div>
                    <!-- Pipeline validation messages -->
                    <div id="pipeline-validation" class="pipeline-validation hidden"></div>
                    <!-- Node palette with tooltips -->
                    <div class="node-palette">
                        <span style="font-size:0.75rem;color:var(--text-dim);margin-right:0.5rem;">Drag nodes:</span>
                        <div class="node-palette-item" draggable="true" data-node-type="source" title="SOURCE: Where data comes from. Double-click to browse and select files/folders to copy.">
                            <span class="node-icon">üì•</span> Source
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="destination" title="DESTINATION: Where data goes. Double-click to browse and select the target location.">
                            <span class="node-icon">üì§</span> Destination
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="filter" title="FILTER: Only pass files matching a pattern (e.g., *.txt, *.log). Connect between Source and Destination.">
                            <span class="node-icon">üîç</span> Filter
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="transform" title="TRANSFORM: Modify files during transfer (compress, encrypt). Connect between Source and Destination.">
                            <span class="node-icon">‚öôÔ∏è</span> Transform
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="merge" title="MERGE: Combine multiple sources into one stream. Connect multiple Sources to this, then to Destination.">
                            <span class="node-icon">üîó</span> Merge
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="split" title="SPLIT: Send files to multiple destinations. Connect Source to this, then to multiple Destinations.">
                            <span class="node-icon">üìä</span> Split
                        </div>
                        <div class="node-palette-item" draggable="true" data-node-type="conditional" title="CONDITIONAL: Route files based on conditions (size, extension). Files go to different outputs based on rules.">
                            <span class="node-icon">‚ùì</span> Conditional
                        </div>
                    </div>
                    <!-- Quick help -->
                    <div class="pipeline-help">
                        <strong>How to build:</strong>
                        1. Drag a <span class="help-highlight">Source</span> node (where files come from)
                        2. Drag a <span class="help-highlight">Destination</span> node (where files go)
                        3. Connect them by clicking output port ‚Üí input port
                        4. Double-click nodes to configure paths
                    </div>
                    <div class="pipeline-canvas-container" id="pipeline-canvas-container">
                        <svg class="pipeline-canvas" id="pipeline-canvas">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent)" />
                                </marker>
                            </defs>
                            <g id="edges-layer"></g>
                        </svg>
                        <div id="nodes-layer"></div>
                    </div>
                </div>
            </div>

            <!-- API SECTION -->
            <div id="section-api" class="section">
                <div class="page-header">
                    <h1>API Explorer</h1>
                    <p>Test API endpoints directly</p>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="api-row">
                            <div class="api-method">
                                <select id="api-method" onchange="toggleBody()">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="api-url">
                                <input type="text" id="api-endpoint" value="/api/health" placeholder="/api/...">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="sendRequest()">Send</button>
                        </div>
                        <div id="api-body-wrap" class="hidden">
                            <textarea id="api-body" placeholder='{"key": "value"}'></textarea>
                        </div>
                        <div class="api-response" id="api-response">Click Send to make a request</div>
                        <div class="quick-btns">
                            <button class="btn btn-secondary btn-sm" onclick="quickReq('GET','/api/health')">Health</button>
                            <button class="btn btn-secondary btn-sm" onclick="quickReq('GET','/api/auth/me')">Me</button>
                            <button class="btn btn-secondary btn-sm" onclick="quickReq('POST','/api/list_jobs')">Jobs</button>
                            <button class="btn btn-secondary btn-sm" onclick="quickReq('POST','/api/list_backends')">Backends</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WEBSOCKET SECTION -->
            <div id="section-websocket" class="section">
                <div class="page-header">
                    <h1>WebSocket Monitor</h1>
                    <p>Real-time event stream</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Live Events</span>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" id="ws-btn" onclick="toggleWs()">Connect</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearWs()">Clear</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="ws-log" id="ws-log">
                            <div class="empty-state">
                                <p>Connect to see real-time events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CREATE JOB MODAL -->
    <div id="create-job-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Create Transfer Job</span>
                <button class="modal-close" onclick="hideModal('create-job-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-job-form" onsubmit="createJob(event)">
                    <div class="form-group">
                        <label>Source Path</label>
                        <input type="text" id="job-source" placeholder="C:/Users/Documents or S3://bucket/path" required>
                    </div>
                    <div class="form-group">
                        <label>Destination Path</label>
                        <input type="text" id="job-destination" placeholder="S3://backup-bucket/folder or //NAS/share" required>
                    </div>
                    <div class="form-group">
                        <label>Parallel Workers</label>
                        <input type="number" id="job-workers" value="4" min="1" max="32">
                    </div>
                    <div class="form-group">
                        <div class="toggle-group">
                            <div class="toggle" id="job-compress" onclick="toggleOption(this)"></div>
                            <label>Enable Compression</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="toggle-group">
                            <div class="toggle active" id="job-verify" onclick="toggleOption(this)"></div>
                            <label>Verify After Transfer</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="hideModal('create-job-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="createJob(event)">Create Job</button>
            </div>
        </div>
    </div>

    <!-- JOB DETAIL MODAL -->
    <div id="job-detail-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <span class="modal-title">Job Details</span>
                <button class="modal-close" onclick="hideModal('job-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="job-detail-content">
                <div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>
            </div>
            <div class="modal-footer" id="job-detail-actions"></div>
        </div>
    </div>

    <!-- CREATE BACKEND MODAL -->
    <div id="create-backend-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <span class="modal-title">Add Storage Backend</span>
                <button class="modal-close" onclick="hideModal('create-backend-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-backend-form" onsubmit="createBackend(event)">
                    <div class="form-group">
                        <label>Backend Name</label>
                        <input type="text" id="backend-name" placeholder="My S3 Bucket" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="backend-type" onchange="updateBackendForm()" style="width:100%;padding:0.875rem 1rem;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;">
                            <option value="s3">Amazon S3</option>
                            <option value="smb">SMB/Network Share</option>
                            <option value="local">Local Path</option>
                        </select>
                    </div>
                    <!-- S3 Fields -->
                    <div id="s3-fields">
                        <div class="form-group">
                            <label>Bucket Name</label>
                            <input type="text" id="backend-bucket" placeholder="my-bucket">
                        </div>
                        <div class="form-group">
                            <label>Region</label>
                            <input type="text" id="backend-region" placeholder="us-east-1" value="us-east-1">
                        </div>
                        <div class="form-group">
                            <label>Access Key ID</label>
                            <input type="text" id="backend-access-key" placeholder="AKIA...">
                        </div>
                        <div class="form-group">
                            <label>Secret Access Key</label>
                            <input type="password" id="backend-secret-key" placeholder="Secret key">
                        </div>
                    </div>
                    <!-- SMB Fields -->
                    <div id="smb-fields" class="hidden">
                        <div class="form-group">
                            <label>Server Host</label>
                            <input type="text" id="backend-host" placeholder="192.168.1.100 or server.local">
                        </div>
                        <div class="form-group">
                            <label>Share Name</label>
                            <input type="text" id="backend-share" placeholder="Backups">
                        </div>
                        <div class="form-group">
                            <label>Username (optional)</label>
                            <input type="text" id="backend-username" placeholder="domain\\user">
                        </div>
                        <div class="form-group">
                            <label>Password (optional)</label>
                            <input type="password" id="backend-password" placeholder="Password">
                        </div>
                    </div>
                    <!-- Local Fields -->
                    <div id="local-fields" class="hidden">
                        <div class="form-group">
                            <label>Local Path</label>
                            <input type="text" id="backend-path" placeholder="C:/Backups or /mnt/storage">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="hideModal('create-backend-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="createBackend(event)">Add Backend</button>
            </div>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="create-user-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Create User</span>
                <button class="modal-close" onclick="hideModal('create-user-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-user-form" onsubmit="createUser(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="new-username" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="new-password" placeholder="Enter password" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="new-role" style="width:100%;padding:0.875rem 1rem;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;">
                            <option value="viewer">Viewer</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="hideModal('create-user-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="createUser(event)">Create User</button>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="edit-user-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit User</span>
                <button class="modal-close" onclick="hideModal('edit-user-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" disabled style="opacity:0.6;">
                </div>
                <div class="form-group">
                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" id="edit-password" placeholder="New password (optional)">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="edit-role" style="width:100%;padding:0.875rem 1rem;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;">
                        <option value="viewer">Viewer</option>
                        <option value="operator">Operator</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="hideModal('edit-user-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="updateUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- CREATE PIPELINE MODAL -->
    <div id="create-pipeline-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Create Pipeline</span>
                <button class="modal-close" onclick="hideModal('create-pipeline-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-pipeline-form" onsubmit="createPipeline(event)">
                    <div class="form-group">
                        <label>Pipeline Name</label>
                        <input type="text" id="pipeline-name" placeholder="My Transfer Pipeline" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="pipeline-description" placeholder="Describe what this pipeline does..." style="width:100%;min-height:80px;padding:0.75rem;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;resize:vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="hideModal('create-pipeline-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="createPipeline(event)">Create Pipeline</button>
            </div>
        </div>
    </div>

    <!-- NODE CONFIG MODAL -->
    <div id="node-config-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Configure Node</span>
                <button class="modal-close" onclick="hideModal('node-config-modal')">&times;</button>
            </div>
            <div class="modal-body" id="node-config-content">
                <div class="form-group">
                    <label>Node Name</label>
                    <input type="text" id="node-config-name" placeholder="Node name">
                </div>
                <div id="node-config-fields"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedNode()">Delete Node</button>
                <button class="btn btn-secondary btn-sm" onclick="hideModal('node-config-modal')">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveNodeConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let user = null;
        let ws = null;
        let currentPath = 'C:\\';
        let drives = [];

        // Pipeline Editor State
        let currentPipeline = null;
        let selectedNode = null;
        let isDraggingNode = false;
        let dragOffset = { x: 0, y: 0 };
        let isConnecting = false;
        let connectionStart = null;

        // Init
        document.addEventListener('DOMContentLoaded', checkAuth);

        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (res.ok) {
                    user = await res.json();
                    showDashboard();
                }
            } catch (e) {}
        }

        async function login(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');
            btn.innerHTML = '<span class="spinner"></span>';
            err.classList.add('hidden');

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const data = await res.json();
                    user = data.user || data;
                    showDashboard();
                } else {
                    err.textContent = 'Invalid credentials';
                    err.classList.remove('hidden');
                }
            } catch (ex) {
                err.textContent = 'Connection error';
                err.classList.remove('hidden');
            }
            btn.innerHTML = 'Sign In';
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');
            if (user) {
                document.getElementById('user-name').textContent = user.username || 'User';
                document.getElementById('user-role').textContent = user.role || 'User';
                document.getElementById('user-avatar').textContent = (user.username || 'U')[0].toUpperCase();
                // Show Users nav for admins
                if (user.role === 'admin') {
                    document.getElementById('nav-users').style.display = 'flex';
                }
            }
            checkHealth();
            loadJobs();
            initFileExplorer();
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).catch(() => {});
            if (ws) ws.close();
            user = null;
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + name).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
        }

        async function checkHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                document.getElementById('stat-status').textContent = data.status === 'ok' ? 'Online' : 'Error';
            } catch (e) {
                document.getElementById('stat-status').textContent = 'Offline';
            }
        }

        async function loadJobs() {
            const containers = ['recent-jobs', 'all-jobs'];
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';
            });

            try {
                const res = await fetch('/api/list_jobs', { method: 'POST', credentials: 'include' });
                if (res.ok) {
                    const jobs = await res.json();
                    const html = jobs && jobs.length > 0 ? renderJobsTable(jobs) : `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No jobs found</h3>
                            <p>Transfer jobs will appear here</p>
                        </div>`;
                    containers.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = html;
                    });
                    document.getElementById('stat-active').textContent = jobs.filter(j => j.status === 'running').length;
                    document.getElementById('stat-completed').textContent = jobs.filter(j => j.status === 'completed').length;
                }
            } catch (e) {
                containers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '<div class="empty-state"><p>Error loading jobs</p></div>';
                });
            }
        }

        function renderJobsTable(jobs) {
            return `<table class="table">
                <thead><tr><th>ID</th><th>Source</th><th>Destination</th><th>Status</th><th>Progress</th><th>Actions</th></tr></thead>
                <tbody>${jobs.map(j => `
                    <tr>
                        <td><a href="#" onclick="showJobDetail(${j.id});return false;" style="color:var(--accent-light);text-decoration:none;"><code>#${j.id}</code></a></td>
                        <td title="${j.source || ''}">${truncate(j.source, 30) || '-'}</td>
                        <td title="${j.destination || ''}">${truncate(j.destination, 30) || '-'}</td>
                        <td><span class="badge badge-${getBadge(j.status)}">${j.status || 'unknown'}</span></td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <div class="progress"><div class="progress-bar" style="width:${j.progress || 0}%"></div></div>
                                <span style="font-size:0.75rem;color:var(--text-dim);">${Math.round(j.progress || 0)}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-btns">
                                ${j.status === 'pending' ? `<button class="btn btn-success btn-icon" onclick="runJob(${j.id})" title="Start">&#9658;</button>` : ''}
                                ${j.status === 'running' || j.status === 'pending' ? `<button class="btn btn-warning btn-icon" onclick="cancelJob(${j.id})" title="Cancel">&#10006;</button>` : ''}
                                <button class="btn btn-info btn-icon" onclick="showJobDetail(${j.id})" title="Details">&#8505;</button>
                                <button class="btn btn-danger btn-icon" onclick="deleteJob(${j.id})" title="Delete">&#128465;</button>
                            </div>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function getBadge(s) {
            return { completed: 'success', running: 'info', failed: 'danger', pending: 'warning', cancelled: 'warning' }[s] || 'info';
        }

        // Modal helpers
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function toggleOption(el) {
            el.classList.toggle('active');
        }

        // Create Job
        function showCreateJobModal() {
            document.getElementById('job-source').value = '';
            document.getElementById('job-destination').value = '';
            document.getElementById('job-workers').value = '4';
            document.getElementById('job-compress').classList.remove('active');
            document.getElementById('job-verify').classList.add('active');
            showModal('create-job-modal');
        }

        async function createJob(e) {
            e.preventDefault();
            const source = document.getElementById('job-source').value;
            const destination = document.getElementById('job-destination').value;
            const workers = parseInt(document.getElementById('job-workers').value) || 4;
            const compress = document.getElementById('job-compress').classList.contains('active');
            const verify = document.getElementById('job-verify').classList.contains('active');

            if (!source || !destination) {
                alert('Source and destination are required');
                return;
            }

            try {
                const res = await fetch('/api/create_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, destination, compress, verify, parallel_workers: workers }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const jobId = await res.json();
                    hideModal('create-job-modal');
                    loadJobs();
                    alert(`Job #${jobId} created successfully!`);
                } else {
                    const text = await res.text();
                    alert('Failed to create job: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        // Job Actions
        async function runJob(jobId) {
            if (!confirm(`Start job #${jobId}?`)) return;
            try {
                const res = await fetch('/api/run_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId }),
                    credentials: 'include'
                });
                if (res.ok) {
                    loadJobs();
                } else {
                    const text = await res.text();
                    alert('Failed to start job: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function cancelJob(jobId) {
            if (!confirm(`Cancel job #${jobId}?`)) return;
            try {
                const res = await fetch('/api/cancel_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId }),
                    credentials: 'include'
                });
                if (res.ok) {
                    loadJobs();
                } else {
                    const text = await res.text();
                    alert('Failed to cancel job: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function deleteJob(jobId) {
            if (!confirm(`Delete job #${jobId}? This cannot be undone.`)) return;
            try {
                const res = await fetch('/api/delete_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId }),
                    credentials: 'include'
                });
                if (res.ok) {
                    loadJobs();
                    hideModal('job-detail-modal');
                } else {
                    const text = await res.text();
                    alert('Failed to delete job: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        // Job Detail View
        async function showJobDetail(jobId) {
            showModal('job-detail-modal');
            document.getElementById('job-detail-content').innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';
            document.getElementById('job-detail-actions').innerHTML = '';

            try {
                const res = await fetch('/api/get_job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const job = await res.json();
                    document.getElementById('job-detail-content').innerHTML = `
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Job ID</div>
                                <div class="detail-value">#${job.id}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status</div>
                                <div class="detail-value"><span class="badge badge-${getBadge(job.status)}">${job.status}</span></div>
                            </div>
                            <div class="detail-item full">
                                <div class="detail-label">Source</div>
                                <div class="detail-value">${job.source}</div>
                            </div>
                            <div class="detail-item full">
                                <div class="detail-label">Destination</div>
                                <div class="detail-value">${job.destination}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Progress</div>
                                <div class="detail-value">
                                    <div style="display:flex;align-items:center;gap:0.75rem;">
                                        <div class="progress" style="width:100px;"><div class="progress-bar" style="width:${job.progress}%"></div></div>
                                        <span>${Math.round(job.progress)}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Chunks</div>
                                <div class="detail-value">${job.completed_chunks} / ${job.total_chunks} (${job.failed_chunks} failed)</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Created</div>
                                <div class="detail-value">${formatTimestamp(job.created_at)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Updated</div>
                                <div class="detail-value">${formatTimestamp(job.updated_at)}</div>
                            </div>
                        </div>
                    `;

                    // Action buttons based on status
                    let actions = '';
                    if (job.status === 'pending') {
                        actions += `<button class="btn btn-success btn-sm" onclick="runJob(${job.id});hideModal('job-detail-modal');">Start Job</button>`;
                    }
                    if (job.status === 'running' || job.status === 'pending') {
                        actions += `<button class="btn btn-warning btn-sm" onclick="cancelJob(${job.id});hideModal('job-detail-modal');">Cancel</button>`;
                    }
                    actions += `<button class="btn btn-danger btn-sm" onclick="deleteJob(${job.id})">Delete</button>`;
                    document.getElementById('job-detail-actions').innerHTML = actions;
                } else {
                    document.getElementById('job-detail-content').innerHTML = '<div class="empty-state"><p>Failed to load job details</p></div>';
                }
            } catch (ex) {
                document.getElementById('job-detail-content').innerHTML = '<div class="empty-state"><p>Error: ' + ex.message + '</p></div>';
            }
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            const d = new Date(ts * 1000);
            return d.toLocaleString();
        }

        // Backend Management
        async function loadBackends() {
            const container = document.getElementById('backends-list');
            container.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';

            try {
                const res = await fetch('/api/list_backends', { method: 'POST', credentials: 'include' });
                if (res.ok) {
                    const backends = await res.json();
                    if (backends && backends.length > 0) {
                        container.innerHTML = renderBackendsTable(backends);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üóÑÔ∏è</div>
                                <h3>No backends configured</h3>
                                <p>Click "Add Backend" to configure storage</p>
                            </div>`;
                    }
                }
            } catch (e) {
                container.innerHTML = '<div class="empty-state"><p>Error loading backends</p></div>';
            }
        }

        function renderBackendsTable(backends) {
            return `<table class="table">
                <thead><tr><th>Name</th><th>Type</th><th>Details</th><th>Created</th><th>Actions</th></tr></thead>
                <tbody>${backends.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td><span class="badge badge-${getBackendBadge(b.backend_type)}">${b.backend_type}</span></td>
                        <td style="font-size:0.85rem;color:var(--text-dim);">${b.details}</td>
                        <td style="font-size:0.85rem;">${formatTimestamp(b.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-danger btn-icon" onclick="deleteBackend('${b.id}')" title="Delete">&#128465;</button>
                            </div>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        }

        function getBackendBadge(type) {
            return { S3: 'info', SMB: 'warning', Local: 'success' }[type] || 'info';
        }

        function showCreateBackendModal() {
            document.getElementById('backend-name').value = '';
            document.getElementById('backend-type').value = 's3';
            updateBackendForm();
            showModal('create-backend-modal');
        }

        function updateBackendForm() {
            const type = document.getElementById('backend-type').value;
            document.getElementById('s3-fields').classList.toggle('hidden', type !== 's3');
            document.getElementById('smb-fields').classList.toggle('hidden', type !== 'smb');
            document.getElementById('local-fields').classList.toggle('hidden', type !== 'local');
        }

        async function createBackend(e) {
            e.preventDefault();
            const name = document.getElementById('backend-name').value;
            const type = document.getElementById('backend-type').value;

            if (!name) {
                alert('Backend name is required');
                return;
            }

            const payload = { name, backend_type: type };

            if (type === 's3') {
                payload.bucket = document.getElementById('backend-bucket').value;
                payload.region = document.getElementById('backend-region').value || 'us-east-1';
                payload.access_key = document.getElementById('backend-access-key').value;
                payload.secret_key = document.getElementById('backend-secret-key').value;
                if (!payload.bucket || !payload.access_key || !payload.secret_key) {
                    alert('S3 requires bucket, access key, and secret key');
                    return;
                }
            } else if (type === 'smb') {
                payload.host = document.getElementById('backend-host').value;
                payload.share = document.getElementById('backend-share').value;
                payload.username = document.getElementById('backend-username').value;
                payload.password = document.getElementById('backend-password').value;
                if (!payload.host || !payload.share) {
                    alert('SMB requires host and share');
                    return;
                }
            } else if (type === 'local') {
                payload.path = document.getElementById('backend-path').value;
                if (!payload.path) {
                    alert('Local backend requires path');
                    return;
                }
            }

            try {
                const res = await fetch('/api/create_backend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (res.ok) {
                    hideModal('create-backend-modal');
                    loadBackends();
                    alert('Backend added successfully!');
                } else {
                    const text = await res.text();
                    alert('Failed to create backend: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function deleteBackend(backendId) {
            if (!confirm('Delete this backend? This cannot be undone.')) return;
            try {
                const res = await fetch('/api/delete_backend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backend_id: backendId }),
                    credentials: 'include'
                });
                if (res.ok) {
                    loadBackends();
                } else {
                    const text = await res.text();
                    alert('Failed to delete backend: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        // API Explorer
        function toggleBody() {
            const m = document.getElementById('api-method').value;
            document.getElementById('api-body-wrap').classList.toggle('hidden', m !== 'POST');
        }

        async function sendRequest() {
            const method = document.getElementById('api-method').value;
            const endpoint = document.getElementById('api-endpoint').value;
            const body = document.getElementById('api-body').value;
            const out = document.getElementById('api-response');
            out.innerHTML = '<span class="spinner"></span>';

            try {
                const opts = { method, credentials: 'include', headers: {} };
                if (method === 'POST' && body) {
                    opts.headers['Content-Type'] = 'application/json';
                    opts.body = body;
                }
                const res = await fetch(endpoint, opts);
                const text = await res.text();
                let formatted;
                try { formatted = JSON.stringify(JSON.parse(text), null, 2); } catch { formatted = text; }
                out.innerHTML = `<div class="${res.ok ? 'response-ok' : 'response-err'}">${res.status} ${res.statusText}</div>\n${formatted}`;
            } catch (e) {
                out.innerHTML = `<div class="response-err">Error: ${e.message}</div>`;
            }
        }

        function quickReq(m, e) {
            document.getElementById('api-method').value = m;
            document.getElementById('api-endpoint').value = e;
            toggleBody();
            sendRequest();
        }

        // WebSocket
        function toggleWs() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${proto}//${location.host}/ws/events`);
                ws.onopen = () => {
                    document.getElementById('ws-btn').textContent = 'Disconnect';
                    document.getElementById('stat-ws').textContent = 'Live';
                    addWsEvent('Connected');
                };
                ws.onclose = () => {
                    document.getElementById('ws-btn').textContent = 'Connect';
                    document.getElementById('stat-ws').textContent = '--';
                    addWsEvent('Disconnected');
                };
                ws.onmessage = (e) => {
                    try { addWsEvent(JSON.stringify(JSON.parse(e.data), null, 2)); }
                    catch { addWsEvent(e.data); }
                };
            }
        }

        function addWsEvent(msg) {
            const log = document.getElementById('ws-log');
            const empty = log.querySelector('.empty-state');
            if (empty) empty.remove();
            const div = document.createElement('div');
            div.className = 'ws-event';
            div.innerHTML = `<span class="ws-time">[${new Date().toLocaleTimeString()}]</span>${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearWs() {
            document.getElementById('ws-log').innerHTML = '<div class="empty-state"><p>Log cleared</p></div>';
        }

        // ===========================================
        // FILE EXPLORER
        // ===========================================

        async function initFileExplorer() {
            // Initialize drag and drop
            const dropZone = document.getElementById('drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    handleFiles(e.dataTransfer.files);
                });
            }

            // Load drives
            try {
                const res = await fetch('/api/list_drives', { credentials: 'include' });
                if (res.ok) {
                    drives = await res.json();
                    const select = document.getElementById('drive-select');
                    select.innerHTML = drives.map(d => `<option value="${d.path}">${d.name}</option>`).join('');
                    if (drives.length > 0) {
                        currentPath = drives[0].path;
                        document.getElementById('current-path').value = currentPath;
                    }
                }
            } catch (e) {
                console.error('Failed to load drives:', e);
            }

            loadDirectory();
        }

        function changeDrive() {
            const drive = document.getElementById('drive-select').value;
            currentPath = drive;
            document.getElementById('current-path').value = currentPath;
            loadDirectory();
        }

        function navigateToPath() {
            currentPath = document.getElementById('current-path').value;
            loadDirectory();
        }

        function navigateUp() {
            const parts = currentPath.replace(/\\/g, '/').split('/').filter(p => p);
            if (parts.length > 1) {
                parts.pop();
                currentPath = parts.join('/');
                if (currentPath.length === 2 && currentPath[1] === ':') {
                    currentPath += '\\';
                }
            } else if (parts.length === 1 && parts[0].includes(':')) {
                currentPath = parts[0] + '\\';
            }
            document.getElementById('current-path').value = currentPath;
            loadDirectory();
        }

        async function loadDirectory(path) {
            if (path !== undefined) {
                currentPath = path;
                document.getElementById('current-path').value = currentPath;
            }

            const container = document.getElementById('file-list');
            container.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';

            try {
                const res = await fetch('/api/list_dir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentPath }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const entries = await res.json();
                    if (entries && entries.length > 0) {
                        container.innerHTML = entries.map(e => `
                            <div class="file-item" onclick="handleFileClick('${escapeHtml(e.path)}', ${e.is_dir})">
                                <span class="file-icon">${e.is_dir ? (e.name === '..' ? '‚¨ÜÔ∏è' : 'üìÅ') : getFileIcon(e.name)}</span>
                                <span class="file-name">${escapeHtml(e.name)}</span>
                                <span class="file-size">${e.is_dir ? '-' : formatSize(e.size)}</span>
                                <span class="file-date">${e.modified ? formatTimestamp(e.modified) : '-'}</span>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>Empty directory</p></div>';
                    }
                } else {
                    const text = await res.text();
                    container.innerHTML = `<div class="empty-state"><p style="color:var(--danger);">Error: ${text}</p></div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="empty-state"><p style="color:var(--danger);">Error: ${e.message}</p></div>`;
            }
        }

        function handleFileClick(path, isDir) {
            if (isDir) {
                loadDirectory(path);
            }
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            const icons = {
                'txt': 'üìÑ', 'md': 'üìù', 'json': 'üìã', 'xml': 'üìã',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
                'mp3': 'üéµ', 'wav': 'üéµ', 'flac': 'üéµ',
                'mp4': 'üé¨', 'avi': 'üé¨', 'mkv': 'üé¨',
                'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
                'exe': '‚öôÔ∏è', 'msi': '‚öôÔ∏è', 'bat': '‚öôÔ∏è', 'sh': '‚öôÔ∏è',
                'pdf': 'üìï', 'doc': 'üìò', 'docx': 'üìò', 'xls': 'üìó', 'xlsx': 'üìó',
                'js': 'üíõ', 'ts': 'üíô', 'py': 'üêç', 'rs': 'ü¶Ä', 'go': 'üêπ',
            };
            return icons[ext] || 'üìÑ';
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        function selectPath() {
            const path = document.getElementById('current-path').value;
            // Copy to clipboard
            navigator.clipboard.writeText(path).then(() => {
                alert('Path copied to clipboard: ' + path);
            }).catch(() => {
                prompt('Copy this path:', path);
            });
        }

        // File Upload
        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        async function handleFiles(files) {
            if (!files || files.length === 0) return;

            const progressDiv = document.getElementById('upload-progress');
            progressDiv.classList.add('active');
            progressDiv.innerHTML = '';

            for (const file of files) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'upload-item';
                itemDiv.innerHTML = `
                    <span class="file-icon">${getFileIcon(file.name)}</span>
                    <span class="upload-name">${escapeHtml(file.name)}</span>
                    <span class="upload-status">Uploading...</span>
                `;
                progressDiv.appendChild(itemDiv);

                try {
                    const formData = new FormData();
                    formData.append('path', currentPath);
                    formData.append('file', file);

                    const res = await fetch('/api/upload_file', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    if (res.ok) {
                        itemDiv.querySelector('.upload-status').textContent = 'Done!';
                        itemDiv.querySelector('.upload-status').style.color = 'var(--success)';
                    } else {
                        const text = await res.text();
                        itemDiv.querySelector('.upload-status').textContent = 'Failed: ' + text;
                        itemDiv.querySelector('.upload-status').style.color = 'var(--danger)';
                    }
                } catch (ex) {
                    itemDiv.querySelector('.upload-status').textContent = 'Error: ' + ex.message;
                    itemDiv.querySelector('.upload-status').style.color = 'var(--danger)';
                }
            }

            // Refresh directory after uploads
            loadDirectory();
        }

        // ===========================================
        // USER MANAGEMENT
        // ===========================================

        async function loadUsers() {
            const container = document.getElementById('users-list');
            container.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';

            try {
                const res = await fetch('/api/list_users', { method: 'POST', credentials: 'include' });
                if (res.ok) {
                    const users = await res.json();
                    if (users && users.length > 0) {
                        container.innerHTML = renderUsersTable(users);
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                    }
                } else {
                    container.innerHTML = '<div class="empty-state"><p style="color:var(--danger);">Access denied or error loading users</p></div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="empty-state"><p style="color:var(--danger);">Error: ' + e.message + '</p></div>';
            }
        }

        function renderUsersTable(users) {
            return `<table class="table">
                <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
                <tbody>${users.map(u => `
                    <tr>
                        <td><strong>${escapeHtml(u.username)}</strong></td>
                        <td><span class="badge badge-${getRoleBadge(u.role)}">${u.role}</span></td>
                        <td style="font-size:0.85rem;">${formatTimestamp(u.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-info btn-icon" onclick="showEditUserModal(${u.id}, '${escapeHtml(u.username)}', '${u.role}')" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-icon" onclick="deleteUser(${u.id}, '${escapeHtml(u.username)}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        }

        function getRoleBadge(role) {
            return { admin: 'danger', operator: 'warning', viewer: 'info' }[role] || 'info';
        }

        function showCreateUserModal() {
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-role').value = 'viewer';
            showModal('create-user-modal');
        }

        async function createUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                alert('Username and password are required');
                return;
            }

            try {
                const res = await fetch('/api/create_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role }),
                    credentials: 'include'
                });

                if (res.ok) {
                    hideModal('create-user-modal');
                    loadUsers();
                    alert('User created successfully!');
                } else {
                    const text = await res.text();
                    alert('Failed to create user: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        function showEditUserModal(userId, username, role) {
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-username').value = username;
            document.getElementById('edit-password').value = '';
            document.getElementById('edit-role').value = role;
            showModal('edit-user-modal');
        }

        async function updateUser() {
            const userId = parseInt(document.getElementById('edit-user-id').value);
            const password = document.getElementById('edit-password').value;
            const role = document.getElementById('edit-role').value;

            const payload = { user_id: userId };
            if (password) payload.password = password;
            if (role) payload.role = role;

            try {
                const res = await fetch('/api/update_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (res.ok) {
                    hideModal('edit-user-modal');
                    loadUsers();
                    alert('User updated successfully!');
                } else {
                    const text = await res.text();
                    alert('Failed to update user: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;

            try {
                const res = await fetch('/api/delete_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }),
                    credentials: 'include'
                });

                if (res.ok) {
                    loadUsers();
                } else {
                    const text = await res.text();
                    alert('Failed to delete user: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        // ===========================================
        // PIPELINE BUILDER
        // ===========================================

        const nodeTypeIcons = {
            source: 'üì•', destination: 'üì§', transfer: 'üîÑ', transform: '‚öôÔ∏è',
            filter: 'üîç', merge: 'üîó', split: 'üìä', conditional: '‚ùì'
        };

        async function loadPipelines() {
            const container = document.getElementById('pipelines-list');
            container.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="spinner"></span></div>';

            try {
                const res = await fetch('/api/list_pipelines', { method: 'POST', credentials: 'include' });
                if (res.ok) {
                    const pipelines = await res.json();
                    if (pipelines && pipelines.length > 0) {
                        container.innerHTML = pipelines.map(p => `
                            <div class="pipeline-list-item" onclick="openPipelineEditor('${p.id}')">
                                <div class="pipeline-info">
                                    <div class="pipeline-name">${escapeHtml(p.name)}</div>
                                    <div class="pipeline-meta">
                                        ${p.node_count} nodes, ${p.edge_count} connections
                                        <span class="badge badge-${getPipelineStatusBadge(p.status)}" style="margin-left:0.5rem;">${p.status}</span>
                                    </div>
                                </div>
                                <div class="action-btns">
                                    <button class="btn btn-info btn-icon" onclick="event.stopPropagation();openPipelineEditor('${p.id}')" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-icon" onclick="event.stopPropagation();deletePipeline('${p.id}')" title="Delete">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üîÄ</div>
                                <h3>No pipelines yet</h3>
                                <p>Click "New Pipeline" to create your first workflow</p>
                            </div>`;
                    }
                }
            } catch (e) {
                container.innerHTML = '<div class="empty-state"><p style="color:var(--danger);">Error loading pipelines</p></div>';
            }
        }

        function getPipelineStatusBadge(status) {
            return { draft: 'warning', ready: 'success', running: 'info', completed: 'success', failed: 'danger', paused: 'warning' }[status] || 'info';
        }

        function showCreatePipelineModal() {
            document.getElementById('pipeline-name').value = '';
            document.getElementById('pipeline-description').value = '';
            showModal('create-pipeline-modal');
        }

        async function createPipeline(e) {
            e.preventDefault();
            const name = document.getElementById('pipeline-name').value;
            const description = document.getElementById('pipeline-description').value;

            if (!name) {
                alert('Pipeline name is required');
                return;
            }

            try {
                const res = await fetch('/api/create_pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const pipelineId = await res.json();
                    hideModal('create-pipeline-modal');
                    loadPipelines();
                    openPipelineEditor(pipelineId);
                } else {
                    const text = await res.text();
                    alert('Failed to create pipeline: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function openPipelineEditor(pipelineId) {
            try {
                const res = await fetch('/api/get_pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pipeline_id: pipelineId }),
                    credentials: 'include'
                });

                if (res.ok) {
                    currentPipeline = await res.json();
                    document.getElementById('pipeline-list-card').classList.add('hidden');
                    document.getElementById('pipeline-editor-card').classList.remove('hidden');
                    document.getElementById('pipeline-editor-title').textContent = currentPipeline.name;
                    initPipelineEditor();
                    renderPipeline();
                } else {
                    alert('Failed to load pipeline');
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        function closePipelineEditor() {
            document.getElementById('pipeline-editor-card').classList.add('hidden');
            document.getElementById('pipeline-list-card').classList.remove('hidden');
            currentPipeline = null;
            selectedNode = null;
            loadPipelines();
        }

        function initPipelineEditor() {
            const canvas = document.getElementById('pipeline-canvas-container');
            const nodesLayer = document.getElementById('nodes-layer');

            // Setup drag from palette - use addEventListener for reliability
            document.querySelectorAll('.node-palette-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    console.log('Drag started:', item.dataset.nodeType);
                    e.dataTransfer.setData('text/plain', item.dataset.nodeType);
                    e.dataTransfer.effectAllowed = 'copy';
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    canvas.classList.remove('drag-over');
                });
            });

            // Setup drop on canvas - use addEventListener for reliability
            canvas.addEventListener('dragenter', (e) => {
                e.preventDefault();
                canvas.classList.add('drag-over');
            });

            canvas.addEventListener('dragleave', (e) => {
                if (!canvas.contains(e.relatedTarget)) {
                    canvas.classList.remove('drag-over');
                }
            });

            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            canvas.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                canvas.classList.remove('drag-over');

                const nodeType = e.dataTransfer.getData('text/plain');
                console.log('Drop event - nodeType:', nodeType, 'currentPipeline:', currentPipeline?.id);

                if (!nodeType || !currentPipeline) {
                    console.warn('Drop ignored: missing nodeType or currentPipeline');
                    return;
                }

                const rect = canvas.getBoundingClientRect();
                const x = Math.max(10, e.clientX - rect.left - 70);
                const y = Math.max(10, e.clientY - rect.top - 40);

                console.log('Adding node at:', x, y);
                await addNode(nodeType, x, y);
            });

            // Click on canvas to deselect
            canvas.addEventListener('click', (e) => {
                if (e.target === canvas || e.target.id === 'pipeline-canvas' || e.target.id === 'nodes-layer') {
                    selectNode(null);
                }
            });

            console.log('Pipeline editor initialized');
        }

        async function addNode(nodeType, x, y) {
            const name = nodeType.charAt(0).toUpperCase() + nodeType.slice(1) + ' ' + (currentPipeline.nodes.length + 1);

            try {
                const res = await fetch('/api/add_node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pipeline_id: currentPipeline.id,
                        node_type: nodeType,
                        name: name,
                        x: x,
                        y: y
                    }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const nodeId = await res.json();
                    currentPipeline.nodes.push({
                        id: nodeId,
                        node_type: nodeType,
                        name: name,
                        position: { x, y },
                        config: {}
                    });
                    renderPipeline();
                }
            } catch (ex) {
                alert('Error adding node: ' + ex.message);
            }
        }

        function renderPipeline() {
            if (!currentPipeline) return;

            const nodesLayer = document.getElementById('nodes-layer');
            const edgesLayer = document.getElementById('edges-layer');

            // Clear existing
            nodesLayer.innerHTML = '';
            edgesLayer.innerHTML = '';

            // Render nodes
            currentPipeline.nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `dag-node ${node.node_type}${selectedNode === node.id ? ' selected' : ''}`;
                nodeEl.id = `node-${node.id}`;
                nodeEl.style.left = `${node.position.x}px`;
                nodeEl.style.top = `${node.position.y}px`;
                nodeEl.innerHTML = `
                    <div class="dag-node-port input" data-node-id="${node.id}" data-port="in"></div>
                    <div class="dag-node-header">
                        <span>${nodeTypeIcons[node.node_type] || 'üì¶'}</span>
                        ${node.node_type}
                    </div>
                    <div class="dag-node-body">
                        <div class="dag-node-name">${escapeHtml(node.name)}</div>
                    </div>
                    <div class="dag-node-port output" data-node-id="${node.id}" data-port="out"></div>
                `;

                // Make node draggable
                nodeEl.onmousedown = (e) => {
                    if (e.target.classList.contains('dag-node-port')) return;
                    e.preventDefault();
                    selectNode(node.id);
                    isDraggingNode = true;
                    const rect = nodeEl.getBoundingClientRect();
                    dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };

                    const onMouseMove = (me) => {
                        if (!isDraggingNode) return;
                        const container = document.getElementById('pipeline-canvas-container');
                        const containerRect = container.getBoundingClientRect();
                        const newX = me.clientX - containerRect.left - dragOffset.x;
                        const newY = me.clientY - containerRect.top - dragOffset.y;
                        nodeEl.style.left = `${Math.max(0, newX)}px`;
                        nodeEl.style.top = `${Math.max(0, newY)}px`;
                        node.position.x = Math.max(0, newX);
                        node.position.y = Math.max(0, newY);
                        renderEdges();
                    };

                    const onMouseUp = async () => {
                        isDraggingNode = false;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        // Save position
                        await fetch('/api/update_node', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pipeline_id: currentPipeline.id,
                                node_id: node.id,
                                x: node.position.x,
                                y: node.position.y
                            }),
                            credentials: 'include'
                        });
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };

                // Double click to configure
                nodeEl.ondblclick = () => showNodeConfig(node.id);

                // Port click for connections
                nodeEl.querySelectorAll('.dag-node-port').forEach(port => {
                    port.onmousedown = (e) => {
                        e.stopPropagation();
                        if (port.classList.contains('output')) {
                            isConnecting = true;
                            connectionStart = { nodeId: node.id, port: 'out' };
                        }
                    };
                    port.onmouseup = async (e) => {
                        e.stopPropagation();
                        if (isConnecting && connectionStart && port.classList.contains('input')) {
                            const targetNodeId = port.dataset.nodeId;
                            if (connectionStart.nodeId !== targetNodeId) {
                                await addEdge(connectionStart.nodeId, targetNodeId);
                            }
                        }
                        isConnecting = false;
                        connectionStart = null;
                    };
                });

                nodesLayer.appendChild(nodeEl);
            });

            renderEdges();
        }

        function renderEdges() {
            const edgesLayer = document.getElementById('edges-layer');
            edgesLayer.innerHTML = '';

            currentPipeline.edges.forEach(edge => {
                const sourceNode = currentPipeline.nodes.find(n => n.id === edge.source_node_id);
                const targetNode = currentPipeline.nodes.find(n => n.id === edge.target_node_id);
                if (!sourceNode || !targetNode) return;

                const sourceEl = document.getElementById(`node-${sourceNode.id}`);
                const targetEl = document.getElementById(`node-${targetNode.id}`);
                if (!sourceEl || !targetEl) return;

                const x1 = sourceNode.position.x + sourceEl.offsetWidth;
                const y1 = sourceNode.position.y + sourceEl.offsetHeight / 2;
                const x2 = targetNode.position.x;
                const y2 = targetNode.position.y + targetEl.offsetHeight / 2;

                // Create curved path
                const midX = (x1 + x2) / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('stroke', 'var(--accent)');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.style.cursor = 'pointer';
                path.onclick = () => {
                    if (confirm('Delete this connection?')) {
                        removeEdge(edge.id);
                    }
                };
                edgesLayer.appendChild(path);
            });
        }

        async function addEdge(sourceNodeId, targetNodeId) {
            try {
                const res = await fetch('/api/add_edge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pipeline_id: currentPipeline.id,
                        source_node_id: sourceNodeId,
                        target_node_id: targetNodeId
                    }),
                    credentials: 'include'
                });

                if (res.ok) {
                    const edgeId = await res.json();
                    currentPipeline.edges.push({
                        id: edgeId,
                        source_node_id: sourceNodeId,
                        target_node_id: targetNodeId,
                        source_port: 'out',
                        target_port: 'in'
                    });
                    renderEdges();
                } else {
                    const text = await res.text();
                    alert('Failed to add connection: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function removeEdge(edgeId) {
            try {
                await fetch('/api/remove_edge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pipeline_id: currentPipeline.id,
                        edge_id: edgeId
                    }),
                    credentials: 'include'
                });
                currentPipeline.edges = currentPipeline.edges.filter(e => e.id !== edgeId);
                renderEdges();
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        function selectNode(nodeId) {
            selectedNode = nodeId;
            document.querySelectorAll('.dag-node').forEach(el => {
                el.classList.toggle('selected', el.id === `node-${nodeId}`);
            });
        }

        function showNodeConfig(nodeId) {
            const node = currentPipeline.nodes.find(n => n.id === nodeId);
            if (!node) return;

            selectedNode = nodeId;
            document.getElementById('node-config-name').value = node.name;

            // Generate config fields based on node type
            const fieldsContainer = document.getElementById('node-config-fields');
            let fieldsHtml = '';
            let descHtml = '';

            if (node.node_type === 'source') {
                descHtml = '<div class="node-config-desc">Select the folder or files to copy FROM. All files in this location will be transferred.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Source Path</label>
                        <div class="input-with-button">
                            <input type="text" id="node-config-path" value="${escapeHtml(node.config.path || '')}" placeholder="C:\\data\\source or /path/to/source">
                            <button class="btn btn-secondary btn-sm" onclick="browseForNodePath('source')">Browse...</button>
                        </div>
                        <small class="form-hint">All files in this directory will be included</small>
                    </div>
                    <div class="form-group">
                        <label>File Pattern (optional)</label>
                        <input type="text" id="node-config-pattern" value="${escapeHtml(node.config.pattern || '')}" placeholder="*.* (all files)">
                        <small class="form-hint">Filter files: *.txt, *.log, data_*.csv</small>
                    </div>
                `;
            } else if (node.node_type === 'destination') {
                descHtml = '<div class="node-config-desc">Select where files should be copied TO. Files will be written to this location.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Destination Path</label>
                        <div class="input-with-button">
                            <input type="text" id="node-config-path" value="${escapeHtml(node.config.path || '')}" placeholder="C:\\data\\backup or /path/to/destination">
                            <button class="btn btn-secondary btn-sm" onclick="browseForNodePath('destination')">Browse...</button>
                        </div>
                    </div>
                `;
            } else if (node.node_type === 'filter') {
                descHtml = '<div class="node-config-desc">Only files matching the pattern will pass through. Connect between Source and Destination.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Pattern (glob)</label>
                        <input type="text" id="node-config-pattern" value="${escapeHtml(node.config.pattern || '')}" placeholder="*.txt">
                        <small class="form-hint">Examples: *.txt, *.log, report_*.csv, **/*.json</small>
                    </div>
                `;
            } else if (node.node_type === 'transform') {
                descHtml = '<div class="node-config-desc">Modify files during transfer. Enable compression or encryption as needed.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <div class="toggle-group">
                            <div class="toggle${node.config.compress ? ' active' : ''}" id="node-config-compress" onclick="toggleOption(this)"></div>
                            <label>Enable Compression (gzip)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="toggle-group">
                            <div class="toggle${node.config.encrypt ? ' active' : ''}" id="node-config-encrypt" onclick="toggleOption(this)"></div>
                            <label>Enable Encryption (AES-256)</label>
                        </div>
                    </div>
                `;
            } else if (node.node_type === 'merge') {
                descHtml = '<div class="node-config-desc">Combines files from multiple sources into a single stream. Connect multiple Source nodes to this node.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Merge Strategy</label>
                        <select id="node-config-strategy">
                            <option value="all" ${!node.config.condition || node.config.condition === 'all' ? 'selected' : ''}>Include All Files</option>
                            <option value="newest" ${node.config.condition === 'newest' ? 'selected' : ''}>Newest Version Only</option>
                            <option value="largest" ${node.config.condition === 'largest' ? 'selected' : ''}>Largest File Only</option>
                        </select>
                        <small class="form-hint">How to handle duplicate filenames from different sources</small>
                    </div>
                `;
            } else if (node.node_type === 'split') {
                descHtml = '<div class="node-config-desc">Sends files to multiple destinations. Connect this node to multiple Destination nodes.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Split Mode</label>
                        <select id="node-config-strategy">
                            <option value="duplicate" ${!node.config.condition || node.config.condition === 'duplicate' ? 'selected' : ''}>Duplicate to All</option>
                            <option value="round_robin" ${node.config.condition === 'round_robin' ? 'selected' : ''}>Round Robin</option>
                        </select>
                        <small class="form-hint">Duplicate: copy to all destinations. Round Robin: distribute evenly.</small>
                    </div>
                `;
            } else if (node.node_type === 'conditional') {
                descHtml = '<div class="node-config-desc">Route files based on conditions. Files matching the condition go to the first output, others to the second.</div>';
                fieldsHtml = `
                    <div class="form-group">
                        <label>Condition Type</label>
                        <select id="node-config-condition-type" onchange="updateConditionFields()">
                            <option value="extension" ${node.config.condition?.startsWith('ext:') ? 'selected' : ''}>By File Extension</option>
                            <option value="size" ${node.config.condition?.startsWith('size:') ? 'selected' : ''}>By File Size</option>
                            <option value="name" ${node.config.condition?.startsWith('name:') ? 'selected' : ''}>By File Name</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Condition Value</label>
                        <input type="text" id="node-config-condition" value="${escapeHtml(node.config.condition?.split(':')[1] || '')}" placeholder=".txt,.csv or >10MB or *_backup*">
                        <small class="form-hint">Extension: .txt,.csv | Size: >10MB, <1GB | Name: pattern</small>
                    </div>
                `;
            }

            fieldsContainer.innerHTML = descHtml + fieldsHtml;
            showModal('node-config-modal');
        }

        // Track browsing state for node config
        let browsingForNode = null;

        function browseForNodePath(nodeType) {
            browsingForNode = { nodeType, nodeId: selectedNode };
            // Store current pipeline editor state
            hideModal('node-config-modal');
            // Switch to file explorer with callback mode
            showSection('files');
            showBrowseMode(nodeType);
        }

        function showBrowseMode(nodeType) {
            // Add a banner at the top of file explorer
            const explorer = document.getElementById('file-explorer');
            let banner = document.getElementById('browse-mode-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'browse-mode-banner';
                banner.className = 'browse-mode-banner';
                explorer.parentNode.insertBefore(banner, explorer);
            }
            banner.innerHTML = `
                <span>Select a ${nodeType === 'source' ? 'source' : 'destination'} folder, then click:</span>
                <button class="btn btn-primary btn-sm" onclick="selectBrowsedPath()">Use This Folder</button>
                <button class="btn btn-secondary btn-sm" onclick="cancelBrowse()">Cancel</button>
            `;
            banner.classList.remove('hidden');
        }

        function selectBrowsedPath() {
            if (!browsingForNode) return;
            const path = currentPath;
            // Go back to pipelines and set the path
            showSection('pipelines');
            // Re-open the pipeline editor if we have a current pipeline
            if (currentPipeline) {
                document.getElementById('pipeline-list-card').classList.add('hidden');
                document.getElementById('pipeline-editor-card').classList.remove('hidden');
                // Re-open node config with the selected path
                const node = currentPipeline.nodes.find(n => n.id === browsingForNode.nodeId);
                if (node) {
                    node.config.path = path;
                    showNodeConfig(browsingForNode.nodeId);
                }
            }
            hideBrowseBanner();
            browsingForNode = null;
        }

        function cancelBrowse() {
            showSection('pipelines');
            if (currentPipeline) {
                document.getElementById('pipeline-list-card').classList.add('hidden');
                document.getElementById('pipeline-editor-card').classList.remove('hidden');
                if (browsingForNode) {
                    showNodeConfig(browsingForNode.nodeId);
                }
            }
            hideBrowseBanner();
            browsingForNode = null;
        }

        function hideBrowseBanner() {
            const banner = document.getElementById('browse-mode-banner');
            if (banner) banner.classList.add('hidden');
        }

        async function saveNodeConfig() {
            if (!selectedNode || !currentPipeline) return;

            const node = currentPipeline.nodes.find(n => n.id === selectedNode);
            if (!node) return;

            const name = document.getElementById('node-config-name').value;
            const config = {};

            // Collect config based on node type
            if (node.node_type === 'source') {
                config.path = document.getElementById('node-config-path')?.value || null;
                config.pattern = document.getElementById('node-config-pattern')?.value || null;
            } else if (node.node_type === 'destination') {
                config.path = document.getElementById('node-config-path')?.value || null;
            } else if (node.node_type === 'filter') {
                config.pattern = document.getElementById('node-config-pattern')?.value || null;
            } else if (node.node_type === 'transform') {
                config.compress = document.getElementById('node-config-compress')?.classList.contains('active') || null;
                config.encrypt = document.getElementById('node-config-encrypt')?.classList.contains('active') || null;
            } else if (node.node_type === 'merge' || node.node_type === 'split') {
                config.condition = document.getElementById('node-config-strategy')?.value || null;
            } else if (node.node_type === 'conditional') {
                const condType = document.getElementById('node-config-condition-type')?.value || 'extension';
                const condValue = document.getElementById('node-config-condition')?.value || '';
                config.condition = `${condType}:${condValue}`;
            }

            try {
                await fetch('/api/update_node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pipeline_id: currentPipeline.id,
                        node_id: selectedNode,
                        name: name,
                        config: config
                    }),
                    credentials: 'include'
                });

                node.name = name;
                node.config = { ...node.config, ...config };
                hideModal('node-config-modal');
                renderPipeline();
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        // Pipeline validation
        function validatePipeline() {
            if (!currentPipeline) return;

            const errors = [];
            const warnings = [];

            // Rule 1: Must have at least one Source node
            const sources = currentPipeline.nodes.filter(n => n.node_type === 'source');
            if (sources.length === 0) {
                errors.push('Pipeline must have at least one Source node');
            }

            // Rule 2: Must have at least one Destination node
            const destinations = currentPipeline.nodes.filter(n => n.node_type === 'destination');
            if (destinations.length === 0) {
                errors.push('Pipeline must have at least one Destination node');
            }

            // Rule 3: All Source nodes must have a path configured
            sources.forEach(s => {
                if (!s.config.path) {
                    errors.push(`Source "${s.name}" has no path configured (double-click to set)`);
                }
            });

            // Rule 4: All Destination nodes must have a path configured
            destinations.forEach(d => {
                if (!d.config.path) {
                    errors.push(`Destination "${d.name}" has no path configured (double-click to set)`);
                }
            });

            // Rule 5: Source nodes should only have outputs (no incoming edges)
            sources.forEach(s => {
                const incoming = currentPipeline.edges.filter(e => e.target_node_id === s.id);
                if (incoming.length > 0) {
                    errors.push(`Source "${s.name}" should not have incoming connections`);
                }
            });

            // Rule 6: Destination nodes should only have inputs (no outgoing edges)
            destinations.forEach(d => {
                const outgoing = currentPipeline.edges.filter(e => e.source_node_id === d.id);
                if (outgoing.length > 0) {
                    errors.push(`Destination "${d.name}" should not have outgoing connections`);
                }
            });

            // Rule 7: Check for orphan nodes (nodes with no connections)
            currentPipeline.nodes.forEach(n => {
                const hasEdge = currentPipeline.edges.some(e =>
                    e.source_node_id === n.id || e.target_node_id === n.id
                );
                if (!hasEdge) {
                    warnings.push(`Node "${n.name}" is not connected to anything`);
                }
            });

            // Rule 8: Check that there's a path from source to destination
            if (sources.length > 0 && destinations.length > 0 && currentPipeline.edges.length === 0) {
                errors.push('No connections between nodes - connect Source to Destination');
            }

            // Display results
            const validationDiv = document.getElementById('pipeline-validation');
            validationDiv.classList.remove('hidden', 'valid', 'invalid');

            if (errors.length === 0 && warnings.length === 0) {
                validationDiv.classList.add('valid');
                validationDiv.innerHTML = '‚úì Pipeline is valid and ready to run!';
            } else if (errors.length === 0) {
                validationDiv.classList.add('valid');
                validationDiv.innerHTML = `‚úì Pipeline is valid with ${warnings.length} warning(s):<ul>${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
            } else {
                validationDiv.classList.add('invalid');
                let html = `‚úó Pipeline has ${errors.length} error(s):<ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
                if (warnings.length > 0) {
                    html += `<br>Warnings:<ul>${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
                }
                validationDiv.innerHTML = html;
            }

            return errors.length === 0;
        }

        async function deleteSelectedNode() {
            if (!selectedNode || !currentPipeline) return;
            if (!confirm('Delete this node and all its connections?')) return;

            try {
                await fetch('/api/remove_node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pipeline_id: currentPipeline.id,
                        node_id: selectedNode
                    }),
                    credentials: 'include'
                });

                currentPipeline.nodes = currentPipeline.nodes.filter(n => n.id !== selectedNode);
                currentPipeline.edges = currentPipeline.edges.filter(e =>
                    e.source_node_id !== selectedNode && e.target_node_id !== selectedNode
                );
                selectedNode = null;
                hideModal('node-config-modal');
                renderPipeline();
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }

        async function savePipeline() {
            if (!currentPipeline) return;
            alert('Pipeline saved! Status: ' + currentPipeline.status);
        }

        async function deletePipeline(pipelineId) {
            if (!confirm('Delete this pipeline? This cannot be undone.')) return;

            try {
                const res = await fetch('/api/delete_pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pipeline_id: pipelineId }),
                    credentials: 'include'
                });

                if (res.ok) {
                    loadPipelines();
                } else {
                    const text = await res.text();
                    alert('Failed to delete pipeline: ' + text);
                }
            } catch (ex) {
                alert('Error: ' + ex.message);
            }
        }
    </script>
</body>
</html>
