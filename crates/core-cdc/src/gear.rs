//! The Gear Hash Implementation
//!
//! A fast, rolling hash algorithm optimized for content-defined chunking.
//! It maps every byte (0-255) to a random 64-bit integer and combines them.

/// The pre-computed Gear table.
/// 256 random 64-bit values for uniform hash distribution.
/// Generated deterministically from BLAKE3("gear_table_{i}") for i in 0..256.
/// Each value is an independently derived random u64.
#[rustfmt::skip]
static GEAR_TABLE: [u64; 256] = [
    // 0x00..0x0F
    0x4d5a82553972c337, 0x4d026217c2e92217, 0x02d412548412c445, 0x769bdd30ec6d923d,
    0xec37b3af4d87b4ac, 0xf826dc9365c5a7e7, 0x9e035d2fbcf017bd, 0x89ddbc0605375f2c,
    0x72c2124669123806, 0xb99a668b181a5e63, 0x0d45ef3350f56543, 0x1f72e7d6b08d5097,
    0x4125426d645cdcef, 0x408465e899b25361, 0x77588830dde97ddb, 0x23cc20cdb76e117d,
    // 0x10..0x1F
    0x20e62a26ca63527d, 0x72c4dc3b10786312, 0x11bc187237508818, 0x97dd98b18b46e6bf,
    0x70e6c8c3806559e7, 0xf56c7863ba09d19f, 0xc5478c862a35a1d8, 0xa1e3c47ce4e0cffe,
    0x3dded7ae27407554, 0xe1c2772cb7a03bd0, 0xe6b1c46890916749, 0xfa3063937a93d1da,
    0x66875c885b127d50, 0x8d7e7c35fabae4ce, 0x2426bf9991f6cbe5, 0xe37fc572899de7ee,
    // 0x20..0x2F
    0x58728384723eefcc, 0x74423f7772570727, 0xfdf5c31abc336319, 0x26d9d21bbd2b2be2,
    0x290d7793449924dd, 0x2a0cded311667604, 0x86b53bc23cf0530b, 0x72b6b6ab9c47d360,
    0x1aed87ccb1d39820, 0x3d759a5c25a6a7b2, 0x33cacff6754209a4, 0x94acef252a44d745,
    0xc1955123c912097b, 0x64f0c4ee8082aa04, 0xde04ae624e0701fb, 0x4c15519d7978d8dd,
    // 0x30..0x3F
    0xe11d7726ce3805a6, 0xde61966b792719d9, 0x94b4946cd583c772, 0xae9bad71a40569fa,
    0x90d37cb1681b33b5, 0x7bc337a7d0afe27d, 0xad63a659c1dbf5d8, 0x80264b86272d9b93,
    0x2f8405973ab05dfd, 0x40763e8bdbb701b4, 0x93dd851cf850799f, 0x171df36e9c3c9eb5,
    0x6785e7edc0f2c143, 0x656cc29b8512bc2d, 0xf9c81cd09e7e0bc9, 0x65a2958215abbb06,
    // 0x40..0x4F
    0x0951f19da367678a, 0x8d9daf0e39c0a9f0, 0x32b57bd9d0196c7a, 0x5f18fa698082b86b,
    0xf369586a0b296dcb, 0xd18c7fbb8d09a6eb, 0x17b7df35e59445b8, 0x45899e3ec894e95c,
    0x999a0c1ed02c28ca, 0xa0751af35018f279, 0xef4cae9dfa75cfbd, 0xf0e702d35215f88f,
    0x8ac897fb75b27ea8, 0x4280b03e88715cfc, 0x28cd64760edfb72f, 0xd9a9ef49c19d0838,
    // 0x50..0x5F
    0x8070172f4af0b900, 0x76b212b8df6d6c32, 0xbe33749e6e346032, 0x8da04bd1814f62ee,
    0x4b57dc4ae99822f6, 0x0880e5572caa6615, 0x0e7f3e8a30d26512, 0x127c22303821a318,
    0x031e339da6c17be5, 0x5a098180c955e7f6, 0x5d551ab44030a462, 0xb2d43970127479da,
    0xeaa4a66387a32436, 0x11381c3304f0f5ef, 0x888eeac79fec95e4, 0x3852126e229fb08f,
    // 0x60..0x6F
    0xea7d7bbc9ba50b9f, 0x7a95579d1d9e1704, 0xb31b0c0e287f54b2, 0xa15d5932f5725306,
    0x1f9999bfef5bc94d, 0xc8dbf10869cb204c, 0x72daa42220c85a92, 0x8f97b98b1145dbcc,
    0x811365179259d8f1, 0x278c3bbf881d7d58, 0xfe8f94160b06ec11, 0x5f18fda54ecd5df1,
    0xcedd912c994aedb7, 0x9f929fc785720dc2, 0x4c1cf62cb2f005cd, 0xa20d54e6172287c1,
    // 0x70..0x7F
    0xd3731f6826327cdc, 0x69272cbd2755d067, 0xe35f18f56bb8911a, 0x9757293a4949819b,
    0x1b6a078095938542, 0xce29db538afeb39a, 0xe0efbe9a23649567, 0x0cceed0c6c70e8c0,
    0xc3da58569a27eb2f, 0x119247427392c899, 0x1b0e389a90a485bf, 0xbfd44c3ea35f9b5f,
    0x950240c9fc8b9894, 0xd674d4ff7196e483, 0xb5e16b9f7d17a841, 0x3dc5ff4f402dd216,
    // 0x80..0x8F
    0x4022b9b4dae69c63, 0x7a2cf27169ce1694, 0xdbd4bc936b1ee83f, 0x135f74680461db13,
    0x4362aebd6a945d30, 0xcf70dfe49b518b87, 0x42883fc1e42f6ac0, 0x0676f809ab31202d,
    0xbed9785a3f2bb2af, 0xedc84f9a94ce52e7, 0x0a1fe134cb334d53, 0x12022073cc2a975b,
    0x36410cea8948d0e3, 0x2bc564441eed2d7b, 0xb9050efa784454dc, 0x778465bbd7933f82,
    // 0x90..0x9F
    0x63735105262ed983, 0x5b24d5f7ec637579, 0x7d0ba2eb55a1800c, 0x56b2322c476b328f,
    0x715bbde518e8b558, 0x2c3d5e7e104bb262, 0x5eda2a02beb9afd4, 0x39f61cbafff350a1,
    0x488dc3976e8cabce, 0xd469ace90440ad6b, 0xd61d2bdfb7c72156, 0xb9290dc152c93176,
    0xda3eec898eef5986, 0xbdaffffd0a4adfac, 0xe527f0ac90642eb5, 0xa3abf1508c2daa79,
    // 0xA0..0xAF
    0x8280ed852ee23b71, 0x51ed9a03477f74d5, 0x54b7941612eb6e0f, 0xcc1e3763c63eeeae,
    0x188d6761161e3649, 0x2fdc18f7c564159e, 0xd96ad44b8cf735c1, 0x3e5427b9ee957136,
    0x589c4b7a3d884ceb, 0x583d021abf7e51b0, 0x742784de7dabb858, 0xa5a1ed3a9333eb96,
    0xff6a277a99655d8e, 0xe31713d84f56d9a5, 0x3ac4153f4e848907, 0x471e45de4fbc0205,
    // 0xB0..0xBF
    0x247189b09ce80d21, 0x3efdb36db73408af, 0x90ffd6ee7cf10c0d, 0xb31dab3a92fb7ae0,
    0x31df8486ae103605, 0x9181ce893fc81e78, 0x5ea13121d1b30c37, 0xa1d92789051f84ae,
    0x6dcf7af568063f50, 0x18d136158c2da890, 0x14f8f678a5b32724, 0x73a58983735f9d33,
    0x08b2ebaedea82ea8, 0xc233915ad2540aa2, 0x957082172b8f10be, 0xd84833ce2f784a8e,
    // 0xC0..0xCF
    0x60ba13709cae4b97, 0x602bdc1308aaf429, 0x99febd9b0d9f59cc, 0x3cb6af4a55637411,
    0xa3a6cc87894acd36, 0x84f0e90ef8fc6767, 0xa249f4a7d55934a1, 0x3a94e3f94ee68948,
    0x1643d6f962cebca9, 0xdcfef4a8381a3401, 0xf0363d6a24eb69fb, 0xd2ed465a711e8ba2,
    0x761bcebfe2ae7ef6, 0xdf6ab488306d0d39, 0x0c510eff09f7cf63, 0x780c191150ab8c26,
    // 0xD0..0xDF
    0xf238a7c20c2d21b1, 0x41fcbc4914a05d34, 0x4665f00295ed1a1e, 0x97ef36c63a9fbfe8,
    0x2963a2529f8eb3fb, 0x01710227af8fff5c, 0x53be27b859b83d50, 0x3066d9f532e8762c,
    0xe4f6660778af1277, 0x3e8704e2c7fd1688, 0x067d3e26a50720d5, 0x2d7173661d9d7e10,
    0xdd4408f0c87d46be, 0xe67a82702a705514, 0x4ad868cf65440075, 0x4705d89162c368bd,
    // 0xE0..0xEF
    0x2c5bb8d5ac254917, 0xec9683bbf4eddc93, 0x2f044c144f5fc0da, 0x97d2161f02de8200,
    0x93c54f9eebf70a5d, 0xa729967d44b231a1, 0x6f2aca53a2271844, 0x0087e63d765f381c,
    0xcc110d8f3a875272, 0x8d4e477b6594903a, 0xd18cc12828f8499b, 0x70dcb674182be87a,
    0x48442a3ce85a6295, 0x2923a581eb22c2c5, 0x7cf40c1aef65e99a, 0x3c826c5ddaf555e2,
    // 0xF0..0xFF
    0x11e97a66a2be78c6, 0xb583cf96984d75d4, 0xe21fb0101fae4f2c, 0x396ad24be13084cb,
    0xa53b6733fb43b5ad, 0xfc7ad33c0e37a2d8, 0xf51222c27acd742f, 0x8863538339ca414c,
    0xf55dbf5af5a28529, 0xef31b90f33bb3b3b, 0xd99be97bdf96d2f6, 0x3142f37c19bc2c62,
    0xd77be53cd4d6f1e7, 0x7b62ee2a41d65f9d, 0x42dc8668aae31ed8, 0x874f2144fb356e2d,
];

#[derive(Debug, Clone, Default)]
pub struct GearHash {
    hash: u64,
}

impl GearHash {
    pub fn new() -> Self {
        Self { hash: 0 }
    }

    #[inline(always)]
    pub fn next(&mut self, byte: u8) -> u64 {
        self.hash = (self.hash.wrapping_shl(1)).wrapping_add(GEAR_TABLE[byte as usize]);
        self.hash
    }

    /// Reset the hash state
    #[allow(dead_code)]
    pub fn reset(&mut self) {
        self.hash = 0;
    }
}
