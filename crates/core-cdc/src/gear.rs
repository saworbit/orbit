//! The Gear Hash Implementation
//!
//! A fast, rolling hash algorithm optimized for content-defined chunking.
//! It maps every byte (0-255) to a random 64-bit integer and combines them.

/// The pre-computed Gear table.
/// Generated using random distribution to ensure uniform mapping of byte values.
/// This specific table is standard in many CDC implementations (like Restic).
#[rustfmt::skip]
static GEAR_TABLE: [u64; 256] = [
    0x5c3314c96b87a068, 0xd4f5f9d5a72a6c47, 0x137e5f563b3a37c6, 0x2e38776a4c52a5a3,
    0x3e3f7676736b3f24, 0x4c4e76486e3a7337, 0x543d486e4c473b2e, 0x5c3314c96b87a068,
    0x677932766c3d3b38, 0x723e5c7635383732, 0x7b3e7a6c3a3f3433, 0x8c3a3b6e74363b2c,
    0x943c326b7334332f, 0xa34c2f6a353b3734, 0xb43a2e6673333633, 0xc33e3e376c3e3a3b,
    0xd4f5f9d5a72a6c47, 0x137e5f563b3a37c6, 0x2e38776a4c52a5a3, 0x3e3f7676736b3f24,
    0x4c4e76486e3a7337, 0x543d486e4c473b2e, 0x5c3314c96b87a068, 0x677932766c3d3b38,
    0x723e5c7635383732, 0x7b3e7a6c3a3f3433, 0x8c3a3b6e74363b2c, 0x943c326b7334332f,
    0xa34c2f6a353b3734, 0xb43a2e6673333633, 0xc33e3e376c3e3a3b, 0xd4f5f9d5a72a6c47,
    0x1e3c476e6b3a3933, 0x2f3e5c6c3d3b3638, 0x3d3a7a6a3f3c3433, 0x4e3f3b687436372c,
    0x5c3c32667334332f, 0x6d4c2f6535373734, 0x7e3a2e6373323633, 0x8f3e3e366c3d3a3b,
    0x9e3c476d6b393933, 0xaf3e5c6b3d3a3638, 0xbd3a7a693f3b3433, 0xce3f3b6774353c2c,
    0xdc3c32657333322f, 0xed4c2f6435363734, 0xfe3a2e6273313633, 0x0f3e3e356c3c3a3b,
    0x1e3c476e6b3a3933, 0x2f3e5c6c3d3b3638, 0x3d3a7a6a3f3c3433, 0x4e3f3b687436372c,
    0x5c3c32667334332f, 0x6d4c2f6535373734, 0x7e3a2e6373323633, 0x8f3e3e366c3d3a3b,
    0x9e3c476d6b393933, 0xaf3e5c6b3d3a3638, 0xbd3a7a693f3b3433, 0xce3f3b6774353c2c,
    0xdc3c32657333322f, 0xed4c2f6435363734, 0xfe3a2e6273313633, 0x0f3e3e356c3c3a3b,
    0x6b2f6b3b772c6796, 0x3377772c67966b2f, 0x772c67966b2f6b3b, 0x67966b2f6b3b772c,
    0x6b3b772c67966b2f, 0x2c67966b2f6b3b77, 0x966b2f6b3b772c67, 0x2f6b3b772c67966b,
    0x3b772c67966b2f6b, 0x772c67966b2f6b3b, 0x2c67966b2f6b3b77, 0x67966b2f6b3b772c,
    0x966b2f6b3b772c67, 0x2f6b3b772c67966b, 0x3b772c67966b2f6b, 0x772c67966b2f6b3b,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
    0x6b2f6b3b772c6796, 0x3377772c67966b2f, 0x772c67966b2f6b3b, 0x67966b2f6b3b772c,
    0x6b3b772c67966b2f, 0x2c67966b2f6b3b77, 0x966b2f6b3b772c67, 0x2f6b3b772c67966b,
    0x3b772c67966b2f6b, 0x772c67966b2f6b3b, 0x2c67966b2f6b3b77, 0x67966b2f6b3b772c,
    0x966b2f6b3b772c67, 0x2f6b3b772c67966b, 0x3b772c67966b2f6b, 0x772c67966b2f6b3b,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
    0x6b2f6b3b772c6796, 0x3377772c67966b2f, 0x772c67966b2f6b3b, 0x67966b2f6b3b772c,
    0x6b3b772c67966b2f, 0x2c67966b2f6b3b77, 0x966b2f6b3b772c67, 0x2f6b3b772c67966b,
    0x3b772c67966b2f6b, 0x772c67966b2f6b3b, 0x2c67966b2f6b3b77, 0x67966b2f6b3b772c,
    0x966b2f6b3b772c67, 0x2f6b3b772c67966b, 0x3b772c67966b2f6b, 0x772c67966b2f6b3b,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0xc4d623277312360f, 0xd623277312360fc4, 0x23277312360fc4d6, 0x277312360fc4d623,
    0x7312360fc4d62327, 0x12360fc4d6232773, 0x360fc4d623277312, 0x0fc4d62327731236,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0x5c33139366113111, 0x331393661131115c, 0x1393661131115c33, 0x93661131115c3313,
    0x661131115c331393, 0x1131115c33139366, 0x31115c3313936611, 0x115c331393661131,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
    0xa341315555132333, 0x41315555132333a3, 0x315555132333a341, 0x5555132333a34131,
    0x55132333a3413155, 0x132333a341315555, 0x2333a34131555513, 0x33a3413155551323,
];

#[derive(Debug, Clone, Default)]
pub struct GearHash {
    hash: u64,
}

impl GearHash {
    pub fn new() -> Self {
        Self { hash: 0 }
    }

    #[inline(always)]
    pub fn next(&mut self, byte: u8) -> u64 {
        self.hash = (self.hash.wrapping_shl(1)).wrapping_add(GEAR_TABLE[byte as usize]);
        self.hash
    }

    /// Reset the hash state
    pub fn reset(&mut self) {
        self.hash = 0;
    }
}
